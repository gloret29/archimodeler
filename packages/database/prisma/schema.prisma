// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles     Role[]
  groups    Group[]

  requestedChanges ChangeRequest[] @relation("Requester")
  reviewedChanges  ChangeRequest[] @relation("Reviewer")
  
  notifications Notification[]
  sentMessages ChatMessage[] @relation("SentMessages")
  receivedMessages ChatMessage[] @relation("ReceivedMessages")
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique // Consumer, Contributor, Designer, Lead Designer, System Administrator
  description String?
  users       User[]
  permissions Permission[]
}

model Permission {
  id          String @id @default(uuid())
  name        String @unique
  description String?
  roles       Role[]
}

model Group {
  id    String @id @default(uuid())
  name  String @unique
  users User[]
}

model SystemSetting {
  key         String   @id
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
}

// --- Metamodel Engine ---

model ModelPackage {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  elements      Element[]
  relationships Relationship[]
  folders       Folder[]
  views         View[]
  
  status        WorkflowStatus @default(DRAFT)
  changeRequests ChangeRequest[]
}

enum WorkflowStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

model ChangeRequest {
  id             String         @id @default(uuid())
  title          String
  description    String?
  status         WorkflowStatus @default(IN_REVIEW)
  
  modelPackageId String
  modelPackage   ModelPackage   @relation(fields: [modelPackageId], references: [id])
  
  requesterId    String
  requester      User           @relation("Requester", fields: [requesterId], references: [id])
  
  reviewerId     String?
  reviewer       User?          @relation("Reviewer", fields: [reviewerId], references: [id])
  
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model Metamodel {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "ArchiMate 3.1"
  version     String
  description String?
  
  conceptTypes  ConceptType[]
  relationTypes RelationType[]
}

model ConceptType {
  id          String    @id @default(uuid())
  name        String    // e.g., "BusinessActor"
  category    String?   // e.g., "Business Layer"
  metamodelId String
  metamodel   Metamodel @relation(fields: [metamodelId], references: [id])

  elements Element[]

  // Relation Rules
  sourceRules RelationType[] @relation("SourceRules")
  targetRules RelationType[] @relation("TargetRules")
  
  // Stereotypes applicable to this concept type
  applicableStereotypes StereotypeConceptType[]

  @@unique([name, metamodelId])
}

model RelationType {
  id          String    @id @default(uuid())
  name        String    // e.g., "Assignment"
  metamodelId String
  metamodel   Metamodel @relation(fields: [metamodelId], references: [id])
  
  // Validity Rules
  allowedSourceTypes ConceptType[] @relation("SourceRules")
  allowedTargetTypes ConceptType[] @relation("TargetRules")

  relationships Relationship[]
  
  // Stereotypes applicable to this relation type
  applicableStereotypes StereotypeRelationType[]

  @@unique([name, metamodelId])
}

model Element {
  id             String       @id @default(uuid())
  name           String
  documentation  String?
  properties     Json?        // JSONB for flexible attributes
  
  conceptTypeId  String
  conceptType    ConceptType  @relation(fields: [conceptTypeId], references: [id])
  
  modelPackageId String
  modelPackage   ModelPackage @relation(fields: [modelPackageId], references: [id])

  folderId       String?
  folder         Folder?      @relation(fields: [folderId], references: [id])

  // Versioning (Time Travel)
  validFrom      DateTime     @default(now())
  validTo        DateTime?    // Null means current version
  versionId      String       @default(uuid()) // Grouping versions of the same logical element

  sourceRelationships Relationship[] @relation("SourceElement")
  targetRelationships Relationship[] @relation("TargetElement")

  // External Data Source
  externalId     String?
  dataSourceId   String?
  dataSource     DataSource?  @relation(fields: [dataSourceId], references: [id])
  
  // Stereotypes
  stereotypes    ElementStereotype[]
}

model DataSource {
  id          String   @id @default(uuid())
  name        String   @unique
  type        String   // 'ServiceNow', 'Excel', 'CSV'
  config      Json     // URL, Credentials, etc.
  mapping     Json?    // Column mapping configuration
  schedule    String?  // Cron expression for auto-sync
  lastSync    DateTime?
  
  elements    Element[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Relationship {
  id             String       @id @default(uuid())
  name           String?
  documentation  String?
  properties     Json?
  
  relationTypeId String
  relationType   RelationType @relation(fields: [relationTypeId], references: [id])
  
  sourceId       String
  source         Element      @relation("SourceElement", fields: [sourceId], references: [id])
  
  targetId       String
  target         Element      @relation("TargetElement", fields: [targetId], references: [id])

  modelPackageId String
  modelPackage   ModelPackage @relation(fields: [modelPackageId], references: [id])

  // Versioning (Time Travel)
  validFrom      DateTime     @default(now())
  validTo        DateTime?
  versionId      String       @default(uuid())
  
  // Stereotypes
  stereotypes    RelationshipStereotype[]
}

model Folder {
  id             String         @id @default(uuid())
  name           String
  
  parentId       String?
  parent         Folder?        @relation("FolderHierarchy", fields: [parentId], references: [id])
  children       Folder[]       @relation("FolderHierarchy")

  modelPackageId String
  modelPackage   ModelPackage   @relation(fields: [modelPackageId], references: [id])
  
  elements       Element[]
  views          View[]

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model View {
  id             String         @id @default(uuid())
  name           String
  description    String?
  
  // Layout data (nodes, edges, positions)
  content        Json?

  modelPackageId String
  modelPackage   ModelPackage   @relation(fields: [modelPackageId], references: [id])

  folderId       String?
  folder         Folder?        @relation(fields: [folderId], references: [id])

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

// --- Stereotypes System ---

model Stereotype {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  icon        String?  // Icon identifier or URL
  color       String?  // Hex color code
  
  // Dynamic properties schema (JSON schema for extended properties)
  propertiesSchema Json? // Schema defining allowed extended properties
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations to specific ArchiMate types
  applicableConceptTypes StereotypeConceptType[]
  applicableRelationTypes StereotypeRelationType[]
  
  // Relations to elements and relationships (instances)
  elementStereotypes      ElementStereotype[]
  relationshipStereotypes RelationshipStereotype[]
}

// Many-to-many relationship between Stereotype and ConceptType
model StereotypeConceptType {
  id            String      @id @default(uuid())
  stereotypeId  String
  stereotype    Stereotype  @relation(fields: [stereotypeId], references: [id], onDelete: Cascade)
  conceptTypeId String
  conceptType   ConceptType @relation(fields: [conceptTypeId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@unique([stereotypeId, conceptTypeId])
}

// Many-to-many relationship between Stereotype and RelationType
model StereotypeRelationType {
  id            String       @id @default(uuid())
  stereotypeId  String
  stereotype    Stereotype   @relation(fields: [stereotypeId], references: [id], onDelete: Cascade)
  relationTypeId String
  relationType  RelationType @relation(fields: [relationTypeId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@unique([stereotypeId, relationTypeId])
}

model ElementStereotype {
  id            String   @id @default(uuid())
  elementId     String
  element       Element  @relation(fields: [elementId], references: [id], onDelete: Cascade)
  stereotypeId  String
  stereotype    Stereotype @relation(fields: [stereotypeId], references: [id], onDelete: Cascade)
  
  // Extended properties (dynamic based on stereotype.propertiesSchema)
  extendedProperties Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([elementId, stereotypeId])
}

model RelationshipStereotype {
  id            String       @id @default(uuid())
  relationshipId String
  relationship  Relationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  stereotypeId  String
  stereotype    Stereotype   @relation(fields: [stereotypeId], references: [id], onDelete: Cascade)
  
  // Extended properties (dynamic based on stereotype.propertiesSchema)
  extendedProperties Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([relationshipId, stereotypeId])
}

// --- Notifications System ---

enum NotificationType {
  CHANGE_REQUEST_CREATED
  CHANGE_REQUEST_APPROVED
  CHANGE_REQUEST_REJECTED
  CHANGE_REQUEST_PUBLISHED
  ELEMENT_CREATED
  ELEMENT_UPDATED
  RELATIONSHIP_CREATED
  VIEW_CREATED
  VIEW_UPDATED
  SYSTEM_ALERT
  COLLABORATION_INVITE
  CHAT_MESSAGE
}

enum NotificationSeverity {
  INFO
  WARNING
  ERROR
  SUCCESS
}

model Notification {
  id        String            @id @default(uuid())
  type      NotificationType
  severity  NotificationSeverity @default(INFO)
  title     String
  message   String
  read      Boolean           @default(false)
  
  userId    String
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Optional metadata for linking to related entities
  metadata  Json?             // e.g., { changeRequestId: "...", elementId: "...", viewId: "..." }
  
  createdAt DateTime          @default(now())
  readAt    DateTime?
  
  @@index([userId, read])
  @@index([userId, createdAt])
}

model ChatMessage {
  id        String   @id @default(uuid())
  fromId    String
  from      User     @relation("SentMessages", fields: [fromId], references: [id], onDelete: Cascade)
  toId      String
  to        User     @relation("ReceivedMessages", fields: [toId], references: [id], onDelete: Cascade)
  message   String
  createdAt DateTime @default(now())
  
  @@index([fromId, toId, createdAt])
  @@index([toId, fromId, createdAt])
}